<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Catalog Manager{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'catalog/styles.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
</head>
<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
    <nav class="navbar">
        <a href="/" class="nav-brand"><img src="{% static 'catalog/lotsdb_logo.svg' %}" alt="LotsDB" height="28"></a>
        <label class="dropzone" id="dropzone" for="dropzone-input">Add Catalog<input type="file" id="dropzone-input" accept=".xlsx,.csv,.json"></label>
        <form action="{% url 'search_item' %}" method="get" class="nav-search">
            <input type="text" name="q" placeholder="Item ID" class="search-input">
            <button type="submit">Go</button>
        </form>
        <form action="{% url 'logout' %}" method="post" class="nav-logout">
            {% csrf_token %}
            <span class="nav-user">{{ request.session.abc_username }}</span>
            <button type="submit">Logout</button>
        </form>
    </nav>

    {% block body_content %}
    <div class="breadcrumbs">
        {% block breadcrumbs %}<a href="/">Home</a>{% endblock %}
    </div>

    <main class="content">
        {% block content %}{% endblock %}
    </main>
    {% endblock %}

    <div id="toast-container" class="toast-container"></div>

    <script>
    window.showToast = function(msg, type) {
        var container = document.getElementById('toast-container');
        var el = document.createElement('div');
        el.className = 'toast toast-' + type;
        el.textContent = msg;
        container.appendChild(el);
        setTimeout(function() {
            el.classList.add('fade-out');
            setTimeout(function() { el.remove(); }, 300);
        }, 5000);
    }

    // Show pending toast from sessionStorage (persisted across redirect)
    (function() {
        var pending = sessionStorage.getItem('pendingToast');
        if (pending) {
            sessionStorage.removeItem('pendingToast');
            try {
                var data = JSON.parse(pending);
                window.showToast(data.msg, data.type || 'success');
            } catch(e) {}
        }
    })();

    // Show pending toast from server-side session (search redirect)
    {% if pending_toast %}
    (function() {
        var t = {{ pending_toast|safe }};
        if (t && t.msg) window.showToast(t.msg, t.type || 'error');
    })();
    {% endif %}
    </script>

    <script>
    (function() {
        var dropzone = document.getElementById('dropzone');
        var fileInput = document.getElementById('dropzone-input');
        var uploadUrl = '{% url "upload_catalog" %}';
        var csrfToken = '{{ csrf_token }}';
        var allowedExts = ['.xlsx', '.csv', '.json'];

        function getExtension(name) {
            var i = name.lastIndexOf('.');
            return i >= 0 ? name.slice(i).toLowerCase() : '';
        }

        function handleFile(file) {
            if (file.size > 1048576) {
                window.showToast('File too large (max 1 MB)', 'error');
                return;
            }
            var ext = getExtension(file.name);
            if (allowedExts.indexOf(ext) === -1) {
                window.showToast('Unsupported file type: ' + ext + '. Accepted: .xlsx, .csv, .json', 'error');
                return;
            }
            dropzone.classList.add('uploading');
            var form = new FormData();
            form.append('file', file);
            fetch(uploadUrl, {
                method: 'POST',
                headers: {'X-CSRFToken': csrfToken},
                body: form
            }).then(function(resp) { return resp.json(); })
            .then(function(data) {
                dropzone.classList.remove('uploading');
                if (data.success) {
                    if (data.merge) {
                        // Detect 100% failure â€” treat as error
                        if (data.merge.added === 0 && data.merge.updated === 0 && data.merge.unchanged === 0 && data.merge.failed > 0) {
                            var errMsg = 'Merge failed: all ' + data.merge.failed + ' lots encountered errors';
                            if (data.recovery_url) errMsg += '. Visit recovery page to retry.';
                            window.showToast(errMsg, 'error');
                            return;
                        }
                        var msg = 'Added: ' + data.merge.added + ', Updated: ' + data.merge.updated + ', Unchanged: ' + data.merge.unchanged;
                        if (data.merge.failed > 0) {
                            msg += ', Failed: ' + data.merge.failed;
                            if (data.recovery_url) msg += ' (recovery available)';
                        }
                        sessionStorage.setItem('pendingToast', JSON.stringify({msg: msg, type: 'success'}));
                    }
                    window.location.href = data.redirect;
                } else {
                    window.showToast(data.error || 'Upload failed', 'error');
                }
            }).catch(function(err) {
                dropzone.classList.remove('uploading');
                window.showToast('Upload failed: ' + err.message, 'error');
            });
        }

        dropzone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.add('dragover');
        });
        dropzone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.remove('dragover');
        });
        dropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', function() {
            if (fileInput.files.length > 0) {
                handleFile(fileInput.files[0]);
                fileInput.value = '';
            }
        });
    })();
    </script>
</body>
</html>
