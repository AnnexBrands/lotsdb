<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Catalog Manager{% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'catalog/styles.css' %}">
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
</head>
<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
    <nav class="navbar">
        <a href="/" class="nav-brand"><img src="{% static 'catalog/lotsdb_logo.svg' %}" alt="LotsDB" height="28"></a>
        <a href="{% url 'import_list' %}" class="nav-link">Import</a>
        <label class="dropzone" id="dropzone">
            Add Catalog
            <input type="file" id="dropzone-input" accept=".xlsx,.csv,.json">
        </label>
        <form action="{% url 'search' %}" method="get" class="nav-search">
            <input type="text" name="q" placeholder="Search by lot # or item ID..." value="{{ request.GET.q|default:'' }}">
            <button type="submit">Search</button>
        </form>
        <form action="{% url 'logout' %}" method="post" class="nav-logout">
            {% csrf_token %}
            <span class="nav-user">{{ request.session.abc_username }}</span>
            <button type="submit">Logout</button>
        </form>
    </nav>

    {% block body_content %}
    <div class="breadcrumbs">
        {% block breadcrumbs %}<a href="/">Home</a>{% endblock %}
    </div>

    <main class="content">
        {% block content %}{% endblock %}
    </main>
    {% endblock %}

    <div id="toast-container" class="toast-container"></div>

    <script>
    (function() {
        var ALLOWED = ['.xlsx', '.csv', '.json'];
        var UPLOAD_URL = '{% url "upload_catalog" %}';
        var CSRF = '{{ csrf_token }}';
        var dropzone = document.getElementById('dropzone');
        var fileInput = document.getElementById('dropzone-input');
        var uploading = false;

        window.showToast = function(msg, type) {
            var container = document.getElementById('toast-container');
            var el = document.createElement('div');
            el.className = 'toast toast-' + type;
            el.textContent = msg;
            container.appendChild(el);
            setTimeout(function() {
                el.classList.add('fade-out');
                setTimeout(function() { el.remove(); }, 300);
            }, 5000);
        }

        function getExtension(name) {
            var i = name.lastIndexOf('.');
            return i >= 0 ? name.slice(i).toLowerCase() : '';
        }

        function handleFile(file) {
            if (uploading) return;
            var ext = getExtension(file.name);
            if (ALLOWED.indexOf(ext) === -1) {
                showToast('Unsupported file type: ' + ext + '. Accepted: .xlsx, .csv, .json', 'error');
                return;
            }
            uploading = true;
            dropzone.classList.add('uploading');
            var fd = new FormData();
            fd.append('file', file);
            fetch(UPLOAD_URL, {
                method: 'POST',
                headers: {'X-CSRFToken': CSRF},
                body: fd
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    window.location.href = data.redirect;
                } else {
                    showToast(data.error, 'error');
                }
            })
            .catch(function() {
                showToast('Upload failed. Please try again.', 'error');
            })
            .finally(function() {
                uploading = false;
                dropzone.classList.remove('uploading');
            });
        }

        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFile(this.files[0]);
                this.value = '';
            }
        });

        dropzone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!uploading) dropzone.classList.add('dragover');
        });

        dropzone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.remove('dragover');
        });

        dropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropzone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
    })();
    </script>
</body>
</html>
