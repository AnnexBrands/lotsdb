{% extends "catalog/base.html" %}

{% block title %}LotsDB — Catalog Manager{% endblock %}

{% block body_content %}
<div class="shell" data-mobile-panel="sellers">
    <button class="mobile-back-btn" aria-label="Back" hidden>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
        Back
    </button>
    <div id="panel-left1" class="panel panel-left1" data-panel="sellers" hx-sync="this:replace">
        <div class="htmx-indicator"><div class="spinner"></div></div>
        <div id="panel-left1-content" class="panel-content">
            {% include "catalog/partials/seller_list_panel.html" %}
        </div>
    </div>
    <div id="panel-left2" class="panel panel-left2" data-panel="events" hx-sync="this:replace">
        <div class="htmx-indicator"><div class="spinner"></div></div>
        <div id="panel-left2-content" class="panel-content">
            {% if hydrate_events is not None %}
                {% include "catalog/partials/events_panel.html" with seller=hydrate_seller events=hydrate_events paginated=hydrate_events_paginated seller_id=selected_seller_id pagination_url=hydrate_events_pagination_url selected_event_id=selected_event_id oob_sellers=None %}
            {% else %}
            <div class="panel-empty">
                <div class="panel-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M3 10h18"/><path d="M10 4v16"/></svg></div>
                <p>Select a seller to view events</p>
            </div>
            {% endif %}
        </div>
    </div>
    <div id="panel-main" class="panel panel-main" data-panel="lots" hx-sync="this:replace">
        <div class="htmx-indicator"><div class="spinner"></div></div>
        <div id="panel-main-content" class="panel-content">
            {% if hydrate_lots is not None %}
                {% include "catalog/partials/lots_panel.html" with event=hydrate_event lots=hydrate_lots lot_rows=hydrate_lot_rows paginated=hydrate_lots_paginated event_id=selected_event_id seller_id=selected_seller_id pagination_url=hydrate_lots_pagination_url selected_event_id=selected_event_id oob_events=None %}
            {% else %}
            <div class="panel-empty">
                <div class="panel-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14h6"/><path d="M9 18h6"/></svg></div>
                <p>Select an event to view lots</p>
            </div>
            {% endif %}
        </div>
    </div>
    <div id="panel-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>
</div>
<dialog id="lot-modal">
    <div class="modal-container">
        <button class="modal-close" aria-label="Close">&times;</button>
        <div id="lot-modal-body" class="modal-body">
            <div class="modal-loading"><div class="spinner"></div></div>
        </div>
    </div>
</dialog>
<script>
(function() {
    var shell = document.querySelector('.shell');
    if (!shell) return;
    var backBtn = shell.querySelector('.mobile-back-btn');
    var announcer = document.getElementById('panel-announcer');
    var panelOrder = ['sellers', 'events', 'lots'];
    var panelLabels = {sellers: 'Sellers', events: 'Events', lots: 'Lots'};

    function isMobile() {
        return window.matchMedia('(max-width: 767px)').matches;
    }

    function showPanel(name) {
        shell.setAttribute('data-mobile-panel', name);
        backBtn.hidden = (name === 'sellers');
        if (announcer) announcer.textContent = panelLabels[name] + ' panel';
        var panel = shell.querySelector('[data-panel="' + name + '"]');
        if (panel) {
            var focusable = panel.querySelector('a, button, input, [tabindex]');
            if (focusable) focusable.focus();
        }
    }

    document.body.addEventListener('htmx:afterSwap', function(e) {
        if (!isMobile()) return;
        var target = e.detail.target;
        if (target.id === 'panel-left2-content') {
            showPanel('events');
        } else if (target.id === 'panel-main-content') {
            showPanel('lots');
        }
    });

    backBtn.addEventListener('click', function() {
        var current = shell.getAttribute('data-mobile-panel');
        var idx = panelOrder.indexOf(current);
        if (idx > 0) showPanel(panelOrder[idx - 1]);
    });

    window.addEventListener('resize', function() {
        if (!isMobile()) {
            backBtn.hidden = true;
            shell.setAttribute('data-mobile-panel', 'sellers');
        }
    });

    // --- Modal logic ---
    var dialog = document.getElementById('lot-modal');
    var modalBody = document.getElementById('lot-modal-body');
    var loadingHTML = '<div class="modal-loading"><div class="spinner"></div></div>';

    if (dialog) {
        // Close button
        dialog.querySelector('.modal-close').addEventListener('click', function() {
            dialog.close();
        });

        // Backdrop click (click on dialog element itself, not children)
        dialog.addEventListener('click', function(e) {
            if (e.target === dialog) dialog.close();
        });

        // Open modal after HTMX swaps content into modal body + snapshot form values
        document.body.addEventListener('htmx:afterSwap', function(e) {
            if (e.detail.target === modalBody || e.detail.target.id === 'lot-modal-body') {
                if (!dialog.open) dialog.showModal();
                var form = modalBody.querySelector('.override-row');
                if (form) {
                    var snap = {};
                    form.querySelectorAll('input, select').forEach(function(el) {
                        if (el.type === 'hidden') return;
                        snap[el.name] = el.type === 'checkbox' ? el.checked : el.value;
                    });
                    form._snapshot = snap;
                }
            }
        });

        // Close modal on closeModal HX-Trigger event
        document.body.addEventListener('closeModal', function() {
            dialog.close();
        });

        // Show toast on showToast HX-Trigger event
        document.body.addEventListener('showToast', function(e) {
            var d = e.detail;
            if (d && d.message && window.showToast) {
                window.showToast(d.message, d.type || 'success');
            }
        });

        // Reset modal body to loading spinner when dialog closes
        dialog.addEventListener('close', function() {
            modalBody.innerHTML = loadingHTML;
        });

        // Before HTMX sends request targeting modal body, show loading spinner
        document.body.addEventListener('htmx:beforeRequest', function(e) {
            var target = e.detail.target;
            if (target === modalBody || (target && target.id === 'lot-modal-body')) {
                modalBody.innerHTML = loadingHTML;
                if (!dialog.open) dialog.showModal();
            }
        });
    }

    // --- Modal override form dirty tracking ---
    document.body.addEventListener('input', function(e) {
        var form = e.target.closest('.override-row');
        if (form && form.closest('#lot-modal-body')) form.classList.add('dirty');
    });
    document.body.addEventListener('change', function(e) {
        var form = e.target.closest('.override-row');
        if (form && form.closest('#lot-modal-body')) form.classList.add('dirty');
    });

    // --- Modal undo: restore snapshot values ---
    document.body.addEventListener('click', function(e) {
        var btn = e.target.closest('.override-undo');
        if (!btn) return;
        var form = btn.closest('.override-row');
        if (!form || !form._snapshot) return;
        var snap = form._snapshot;
        form.querySelectorAll('input, select').forEach(function(el) {
            if (el.type === 'hidden') return;
            if (el.type === 'checkbox') el.checked = snap[el.name] !== undefined ? snap[el.name] : false;
            else if (snap[el.name] !== undefined) el.value = snap[el.name];
        });
        form.classList.remove('dirty');
        // Re-apply cpack color
        var cpackSel = form.querySelector('select[name="cpack"]');
        if (cpackSel) cpackSel.dispatchEvent(new Event('change'));
    });

    // --- Gallery thumbnail navigation (event-delegated main-image swap) ---
    document.body.addEventListener('click', function(e) {
        var thumb = e.target.closest('.lot-gallery-thumb');
        if (!thumb || !thumb.closest('#lot-modal-body')) return;
        var src = thumb.getAttribute('data-img-src');
        if (!src) return;
        var mainImg = document.getElementById('modal-main-img');
        if (mainImg) mainImg.src = src;
        var thumbs = thumb.closest('.lot-gallery-thumbs');
        if (thumbs) {
            thumbs.querySelectorAll('.lot-gallery-thumb').forEach(function(t) {
                t.classList.toggle('active', t === thumb);
            });
        }
    });

    // --- Card stack navigation (event-delegated) ---
    document.body.addEventListener('click', function(e) {
        var btn = e.target.closest('.stack-nav-btn');
        if (!btn || !btn.closest('#lot-modal-body')) return;
        var col = btn.closest('.stack-column');
        if (!col) return;
        var cards = col.querySelectorAll('.stack-card');
        var counter = col.querySelector('.stack-counter');
        var upBtn = col.querySelector('[data-dir="up"]');
        var downBtn = col.querySelector('[data-dir="down"]');
        var total = cards.length;
        // Find current front card index
        var current = 0;
        cards.forEach(function(card, i) {
            if (card.getAttribute('data-pos') === '0') current = i;
        });
        if (btn.getAttribute('data-dir') === 'up' && current > 0) current--;
        else if (btn.getAttribute('data-dir') === 'down' && current < total - 1) current++;
        // Re-render positions
        cards.forEach(function(card, i) {
            var offset = i - current;
            if (offset < 0 || offset > 2) card.setAttribute('data-pos', 'hidden');
            else card.setAttribute('data-pos', String(offset));
        });
        if (counter) counter.textContent = (current + 1) + '/' + total;
        if (upBtn) upBtn.disabled = current === 0;
        if (downBtn) downBtn.disabled = current >= total - 1;
    });

    // --- Accept button: copy related lot values into override form ---
    document.body.addEventListener('click', function(e) {
        var acceptBtn = e.target.closest('.stack-card-accept');
        if (!acceptBtn || !acceptBtn.closest('#lot-modal-body')) return;
        var card = acceptBtn.closest('.stack-card');
        if (!card) return;
        var form = document.querySelector('#lot-modal-body .override-row');
        if (!form) return;
        var fields = {l: 'l', w: 'w', h: 'h', wgt: 'wgt'};
        for (var key in fields) {
            var val = card.getAttribute('data-' + key);
            var input = form.querySelector('input[name="' + fields[key] + '"]');
            if (input && val) input.value = val;
        }
        var cpackVal = card.getAttribute('data-cpack');
        var cpackSelect = form.querySelector('select[name="cpack"]');
        if (cpackSelect && cpackVal) {
            cpackSelect.value = cpackVal;
            cpackSelect.dispatchEvent(new Event('change'));
        }
    });

    // --- Pagination: jump-to-page ---
    document.body.addEventListener('click', function(e) {
        var display = e.target.closest('.page-display');
        if (!display) return;
        var jump = display.closest('.page-jump');
        if (!jump) return;
        var input = jump.querySelector('.page-input');
        display.hidden = true;
        input.hidden = false;
        input.select();
        input.focus();
    });

    function paginateToPage(input) {
        var page = Math.max(1, Math.min(parseInt(input.value) || 1, parseInt(input.max) || 1));
        var bar = input.closest('.panel-pagination');
        var baseUrl = bar.dataset.baseUrl;
        var target = bar.dataset.target;
        var extra = bar.dataset.extraParams || '';
        var url = baseUrl + '?page=' + page + extra;
        htmx.ajax('GET', url, {target: target, swap: 'innerHTML'});
    }

    document.body.addEventListener('keydown', function(e) {
        if (!e.target.classList.contains('page-input')) return;
        if (e.key === 'Enter') {
            e.preventDefault();
            paginateToPage(e.target);
        } else if (e.key === 'Escape') {
            e.preventDefault();
            var jump = e.target.closest('.page-jump');
            e.target.hidden = true;
            jump.querySelector('.page-display').hidden = false;
        }
    });

    document.body.addEventListener('focusout', function(e) {
        if (!e.target.classList.contains('page-input')) return;
        // Delay to allow click events to fire first
        var input = e.target;
        setTimeout(function() {
            if (!input.hidden) {
                var jump = input.closest('.page-jump');
                if (jump) {
                    input.hidden = true;
                    jump.querySelector('.page-display').hidden = false;
                }
            }
        }, 150);
    });

    // --- Pagination: page size selector ---
    document.body.addEventListener('change', function(e) {
        if (!e.target.classList.contains('page-size-select')) return;
        var select = e.target;
        var bar = select.closest('.panel-pagination');
        var baseUrl = bar.dataset.baseUrl;
        var target = bar.dataset.target;
        var extra = bar.dataset.extraParams || '';
        // Remove existing page_size from extra params, then add new one
        extra = extra.replace(/&page_size=[^&]*/g, '');
        var url = baseUrl + '?page=1&page_size=' + select.value + extra;
        htmx.ajax('GET', url, {target: target, swap: 'innerHTML'});
    });

    // --- Pagination: scroll to top on page change ---
    document.body.addEventListener('htmx:afterSwap', function(e) {
        var target = e.detail.target;
        if (target && target.closest('.panel')) {
            target.closest('.panel').scrollTop = 0;
        }
    });

    // --- Skeleton loading for events panel on seller click ---
    var skeletonItem = '<li class="skeleton-item"><div class="skeleton-bar skeleton-title"></div><div class="skeleton-bar skeleton-meta"></div></li>';
    var skeletonHTML = '<div class="skeleton-loading">'
        + '<div class="skeleton-spinner"><div class="spinner"></div></div>'
        + '<ul class="skeleton-list">'
        + skeletonItem + skeletonItem + skeletonItem + skeletonItem + skeletonItem
        + skeletonItem + skeletonItem + skeletonItem + skeletonItem + skeletonItem
        + skeletonItem + skeletonItem + skeletonItem + skeletonItem + skeletonItem
        + '</ul></div>';
    var mainEmptyHTML = '<div class="panel-empty">'
        + '<div class="panel-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14h6"/><path d="M9 18h6"/></svg></div>'
        + '<p>Select an event to view lots</p></div>';

    // --- Skeleton loading for lots panel on event click ---
    var lotsSkeletonRow = '<tr class="skeleton-table-row">'
        + '<td><div class="skeleton-thumb"></div></td>'
        + '<td><div class="skeleton-bar" style="width:60%;height:0.8125rem;margin-bottom:0.375rem"></div><div class="skeleton-bar" style="width:40%;height:0.625rem"></div></td>'
        + '<td><div class="skeleton-dims"><div class="skeleton-bar skeleton-dims-bar"></div><div class="skeleton-bar skeleton-dims-bar"></div><div class="skeleton-bar skeleton-dims-bar"></div><div class="skeleton-bar skeleton-dims-bar"></div><div class="skeleton-bar skeleton-dims-bar"></div></div></td>'
        + '<td><div class="skeleton-bar" style="width:2.5rem;height:0.75rem"></div></td>'
        + '<td><div class="skeleton-bar" style="width:1rem;height:1rem;border-radius:2px"></div></td>'
        + '<td><div class="skeleton-bar" style="width:1rem;height:1rem;border-radius:2px"></div></td>'
        + '<td></td></tr>';
    var lotsSkeletonHTML = '<table class="lots-table"><thead><tr>'
        + '<th></th><th>Lot Description</th>'
        + '<th style="text-align:center">Dimensions</th>'
        + '<th style="text-align:center">CPack</th>'
        + '<th style="text-align:center">Crate</th>'
        + '<th style="text-align:center">DNT</th>'
        + '<th></th></tr></thead><tbody>'
        + lotsSkeletonRow + lotsSkeletonRow + lotsSkeletonRow + lotsSkeletonRow + lotsSkeletonRow
        + lotsSkeletonRow + lotsSkeletonRow + lotsSkeletonRow + lotsSkeletonRow + lotsSkeletonRow
        + lotsSkeletonRow + lotsSkeletonRow + lotsSkeletonRow + lotsSkeletonRow + lotsSkeletonRow
        + '</tbody></table>';

    var _sellerClicked = false;

    document.body.addEventListener('htmx:beforeRequest', function(e) {
        var target = e.detail.target;
        var elt = e.detail.elt;

        // Ignore clicks on already-active seller or event
        if (elt.classList.contains('panel-item') && elt.classList.contains('active')) {
            e.preventDefault();
            return;
        }

        // Show skeleton for seller click + track for auto-select
        if (target && target.id === 'panel-left2-content' && elt.classList.contains('panel-item')) {
            _sellerClicked = true;
            target.innerHTML = skeletonHTML;
            target.setAttribute('data-seller-id', '');
            var mainContent = document.getElementById('panel-main-content');
            if (mainContent) mainContent.innerHTML = mainEmptyHTML;
        }
        // Show lots skeleton when clicking an event item (panel-item inside events panel)
        if (target && target.id === 'panel-main-content' && elt.classList.contains('panel-item') && elt.closest && elt.closest('#panel-left2')) {
            target.innerHTML = lotsSkeletonHTML;
        }
    });

    // SWR: track current seller on events panel, guard stale refreshes, auto-select first event
    document.body.addEventListener('htmx:afterSwap', function(e) {
        var target = e.detail.target;
        if (target && target.id === 'panel-left2-content') {
            // Extract seller_id from the response URL (e.g., /panels/sellers/42/events/)
            var reqPath = e.detail.pathInfo && e.detail.pathInfo.requestPath || '';
            var m = reqPath.match(/\/panels\/sellers\/(\d+)\/events\//);
            if (m && reqPath.indexOf('fresh=1') === -1) {
                target.setAttribute('data-seller-id', m[1]);
            }
            // Auto-select first event after a seller click
            if (_sellerClicked) {
                _sellerClicked = false;
                var firstEvent = target.querySelector('.panel-item');
                if (firstEvent) firstEvent.click();
            }
        }
    });

    document.body.addEventListener('htmx:beforeSwap', function(e) {
        var target = e.detail.target;
        if (target && target.id === 'panel-left2-content') {
            var reqPath = e.detail.pathInfo && e.detail.pathInfo.requestPath || '';
            if (reqPath.indexOf('fresh=1') !== -1) {
                // This is a SWR background refresh — check if seller still matches
                var m = reqPath.match(/\/panels\/sellers\/(\d+)\/events\//);
                var currentSeller = target.getAttribute('data-seller-id');
                if (m && currentSeller && m[1] !== currentSeller) {
                    e.detail.shouldSwap = false;
                }
            }
        }
    });

    // --- Row auto-save logic ---
    function getLotRow(el) {
        var tr = el.closest('tr[id^="lot-row-"]');
        return tr;
    }

    // Mark row dirty on input/change and reset 15s inactivity timer
    function markDirty(tr) {
        tr.dataset.dirty = '1';
        var btn = tr.querySelector('.override-btn');
        if (btn) btn.classList.remove('save-clean');
        // Reset 15s inactivity timer
        if (tr._inactivityTimer) clearTimeout(tr._inactivityTimer);
        tr._inactivityTimer = setTimeout(function() {
            tr._inactivityTimer = null;
            if (tr.dataset.dirty === '1') htmx.trigger(tr, 'submit');
        }, 15000);
    }

    document.body.addEventListener('input', function(e) {
        var tr = getLotRow(e.target);
        if (tr) markDirty(tr);
    });
    document.body.addEventListener('change', function(e) {
        var tr = getLotRow(e.target);
        if (tr) markDirty(tr);
    });

    // CPack select color update on change
    var cpackClassMap = {'1':'cpack-nf','2':'cpack-lf','3':'cpack-f','4':'cpack-vf','PBO':'cpack-pbo'};
    document.body.addEventListener('change', function(e) {
        if (e.target.name !== 'cpack' || e.target.tagName !== 'SELECT') return;
        var sel = e.target;
        Object.keys(cpackClassMap).forEach(function(k) { sel.classList.remove(cpackClassMap[k]); });
        var cls = cpackClassMap[sel.value];
        if (cls) sel.classList.add(cls);
    });

    // Immediate save on row blur (focus leaving the row entirely)
    document.body.addEventListener('focusout', function(e) {
        var tr = getLotRow(e.target);
        if (!tr || tr.dataset.dirty !== '1') return;
        setTimeout(function() {
            var active = document.activeElement;
            if (active && tr.contains(active)) return;
            // Cancel inactivity timer — blur save takes over
            if (tr._inactivityTimer) { clearTimeout(tr._inactivityTimer); tr._inactivityTimer = null; }
            if (tr._autoSaveTimer) { clearTimeout(tr._autoSaveTimer); tr._autoSaveTimer = null; }
            if (tr.dataset.dirty === '1') htmx.trigger(tr, 'submit');
        }, 0);
    });

    // Cancel timers if focus returns to the row
    document.body.addEventListener('focusin', function(e) {
        var tr = getLotRow(e.target);
        if (tr && tr._autoSaveTimer) {
            clearTimeout(tr._autoSaveTimer);
            tr._autoSaveTimer = null;
        }
    });

    // Clear timers on immediate save click
    document.body.addEventListener('click', function(e) {
        if (!e.target.closest('.btn-icon[type="submit"]')) return;
        var tr = getLotRow(e.target);
        if (tr) {
            if (tr._autoSaveTimer) { clearTimeout(tr._autoSaveTimer); tr._autoSaveTimer = null; }
            if (tr._inactivityTimer) { clearTimeout(tr._inactivityTimer); tr._inactivityTimer = null; }
        }
    });

    // Concurrent save queueing: prevent overlapping saves for the same lot
    // Only applies to the row's own POST (form submit), not child GET requests (e.g. opening modal)
    document.body.addEventListener('htmx:beforeRequest', function(e) {
        var tr = getLotRow(e.detail.elt);
        if (!tr || e.detail.elt !== tr) return;
        if (tr.dataset.saving === '1') {
            // A save is already in flight — queue this one
            e.preventDefault();
            tr._pendingSave = true;
            return;
        }
        tr.dataset.saving = '1';
    });

    // Mark row clean after successful HTMX swap, fire queued saves
    document.body.addEventListener('htmx:afterSwap', function(e) {
        var tr = e.detail.target;
        if (!tr || !tr.id || !tr.id.startsWith('lot-row-')) return;
        tr.dataset.saving = '';
        tr.dataset.dirty = '';
        if (tr._inactivityTimer) { clearTimeout(tr._inactivityTimer); tr._inactivityTimer = null; }
        var btn = tr.querySelector('.override-btn');
        if (btn) {
            btn.classList.add('save-clean');
            setTimeout(function() { btn.classList.remove('save-clean'); }, 3000);
        }
        // Fire queued save if there's a pending one
        if (tr._pendingSave) {
            tr._pendingSave = false;
            markDirty(tr);
            htmx.trigger(tr, 'submit');
        }
    });

    // Clear saving flag on request error too
    document.body.addEventListener('htmx:responseError', function(e) {
        var tr = getLotRow(e.detail.elt);
        if (tr) tr.dataset.saving = '';
    });

    // --- Arrow-key navigation between dims fields ---
    document.body.addEventListener('keydown', function(e) {
        var input = e.target;
        if (!input.classList.contains('lot-dims-input') && !input.classList.contains('lot-dims-wgt')) return;
        if (e.key !== 'ArrowRight' && e.key !== 'ArrowLeft') return;
        var row = input.closest('.lot-dims');
        if (!row) return;
        var inputs = Array.from(row.querySelectorAll('.lot-dims-input, .lot-dims-wgt'));
        var idx = inputs.indexOf(input);
        if (idx === -1) return;
        var next = e.key === 'ArrowRight' ? inputs[idx + 1] : inputs[idx - 1];
        if (next) {
            e.preventDefault();
            next.focus();
            next.select();
        }
    });
})();
</script>
{% endblock %}
