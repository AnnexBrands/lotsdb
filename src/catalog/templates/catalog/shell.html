{% extends "catalog/base.html" %}

{% block title %}LotsDB â€” Catalog Manager{% endblock %}

{% block body_content %}
<div class="shell" data-mobile-panel="sellers">
    <button class="mobile-back-btn" aria-label="Back" hidden>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
        Back
    </button>
    <div id="panel-left1" class="panel panel-left1" data-panel="sellers" hx-sync="this:replace">
        <div class="htmx-indicator"><div class="spinner"></div></div>
        <div id="panel-left1-content" class="panel-content">
            {% include "catalog/partials/seller_list_panel.html" %}
        </div>
    </div>
    <div id="panel-left2" class="panel panel-left2" data-panel="events" hx-sync="this:replace">
        <div class="htmx-indicator"><div class="spinner"></div></div>
        <div id="panel-left2-content" class="panel-content">
            {% if hydrate_events is not None %}
                {% include "catalog/partials/events_panel.html" with seller=hydrate_seller events=hydrate_events paginated=hydrate_events_paginated seller_id=selected_seller_id pagination_url=hydrate_events_pagination_url selected_event_id=selected_event_id oob_sellers=None %}
            {% else %}
            <div class="panel-empty">
                <div class="panel-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M3 10h18"/><path d="M10 4v16"/></svg></div>
                <p>Select a seller to view events</p>
            </div>
            {% endif %}
        </div>
    </div>
    <div id="panel-main" class="panel panel-main" data-panel="lots" hx-sync="this:replace">
        <div class="htmx-indicator"><div class="spinner"></div></div>
        <div id="panel-main-content" class="panel-content">
            {% if hydrate_lots is not None %}
                {% include "catalog/partials/lots_panel.html" with event=hydrate_event lots=hydrate_lots lot_rows=hydrate_lot_rows paginated=hydrate_lots_paginated event_id=selected_event_id seller_id=selected_seller_id pagination_url=hydrate_lots_pagination_url selected_event_id=selected_event_id oob_events=None %}
            {% else %}
            <div class="panel-empty">
                <div class="panel-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14h6"/><path d="M9 18h6"/></svg></div>
                <p>Select an event to view lots</p>
            </div>
            {% endif %}
        </div>
    </div>
    <div id="panel-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>
</div>
<dialog id="lot-modal" aria-labelledby="lot-modal-title">
    <div class="modal-container">
        <div class="modal-header">
            <h2 id="lot-modal-title">Lot Detail</h2>
            <button class="modal-close" aria-label="Close">&times;</button>
        </div>
        <div id="lot-modal-body" class="modal-body">
            <div class="modal-loading"><div class="spinner"></div></div>
        </div>
    </div>
</dialog>
<script>
(function() {
    var shell = document.querySelector('.shell');
    if (!shell) return;
    var backBtn = shell.querySelector('.mobile-back-btn');
    var announcer = document.getElementById('panel-announcer');
    var panelOrder = ['sellers', 'events', 'lots'];
    var panelLabels = {sellers: 'Sellers', events: 'Events', lots: 'Lots'};

    function isMobile() {
        return window.matchMedia('(max-width: 767px)').matches;
    }

    function showPanel(name) {
        shell.setAttribute('data-mobile-panel', name);
        backBtn.hidden = (name === 'sellers');
        if (announcer) announcer.textContent = panelLabels[name] + ' panel';
        var panel = shell.querySelector('[data-panel="' + name + '"]');
        if (panel) {
            var focusable = panel.querySelector('a, button, input, [tabindex]');
            if (focusable) focusable.focus();
        }
    }

    document.body.addEventListener('htmx:afterSwap', function(e) {
        if (!isMobile()) return;
        var target = e.detail.target;
        if (target.id === 'panel-left2-content') {
            showPanel('events');
        } else if (target.id === 'panel-main-content') {
            showPanel('lots');
        }
    });

    backBtn.addEventListener('click', function() {
        var current = shell.getAttribute('data-mobile-panel');
        var idx = panelOrder.indexOf(current);
        if (idx > 0) showPanel(panelOrder[idx - 1]);
    });

    window.addEventListener('resize', function() {
        if (!isMobile()) {
            backBtn.hidden = true;
            shell.setAttribute('data-mobile-panel', 'sellers');
        }
    });

    // --- Modal logic ---
    var dialog = document.getElementById('lot-modal');
    var modalBody = document.getElementById('lot-modal-body');
    var modalTitle = document.getElementById('lot-modal-title');
    var loadingHTML = '<div class="modal-loading"><div class="spinner"></div></div>';

    if (dialog) {
        // Close button
        dialog.querySelector('.modal-close').addEventListener('click', function() {
            dialog.close();
        });

        // Backdrop click (click on dialog element itself, not children)
        dialog.addEventListener('click', function(e) {
            if (e.target === dialog) dialog.close();
        });

        // Open modal after HTMX swaps content into modal body
        document.body.addEventListener('htmx:afterSwap', function(e) {
            if (e.detail.target === modalBody || e.detail.target.id === 'lot-modal-body') {
                // Update title from data attribute
                var firstChild = modalBody.firstElementChild;
                if (firstChild && firstChild.getAttribute('data-lot-title')) {
                    modalTitle.textContent = firstChild.getAttribute('data-lot-title');
                }
                if (!dialog.open) dialog.showModal();
            }
        });

        // Close modal on closeModal HX-Trigger event
        document.body.addEventListener('closeModal', function() {
            dialog.close();
        });

        // Show toast on showToast HX-Trigger event
        document.body.addEventListener('showToast', function(e) {
            var d = e.detail;
            if (d && d.message && window.showToast) {
                window.showToast(d.message, d.type || 'success');
            }
        });

        // Reset modal body to loading spinner when dialog closes
        dialog.addEventListener('close', function() {
            modalBody.innerHTML = loadingHTML;
            modalTitle.textContent = 'Lot Detail';
        });

        // Before HTMX sends request targeting modal body, show loading spinner
        document.body.addEventListener('htmx:beforeRequest', function(e) {
            var target = e.detail.target;
            if (target === modalBody || (target && target.id === 'lot-modal-body')) {
                modalBody.innerHTML = loadingHTML;
                if (!dialog.open) dialog.showModal();
            }
        });
    }
})();
</script>
{% endblock %}
