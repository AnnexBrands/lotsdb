{% extends "catalog/base.html" %}

{% block title %}LotsDB — Catalog Manager{% endblock %}

{% block body_content %}
<div class="shell" data-mobile-panel="sellers">
    <button class="mobile-back-btn" aria-label="Back" hidden>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
        Back
    </button>
    <div id="panel-left1" class="panel panel-left1" data-panel="sellers" hx-sync="this:replace">
        <div class="htmx-indicator"><div class="spinner"></div></div>
        <div id="panel-left1-content" class="panel-content">
            {% include "catalog/partials/seller_list_panel.html" %}
        </div>
    </div>
    <div id="panel-left2" class="panel panel-left2" data-panel="events" hx-sync="this:replace">
        <div class="htmx-indicator"><div class="spinner"></div></div>
        <div id="panel-left2-content" class="panel-content">
            {% if hydrate_events is not None %}
                {% include "catalog/partials/events_panel.html" with seller=hydrate_seller events=hydrate_events paginated=hydrate_events_paginated seller_id=selected_seller_id pagination_url=hydrate_events_pagination_url selected_event_id=selected_event_id oob_sellers=None %}
            {% else %}
            <div class="panel-empty">
                <div class="panel-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M3 10h18"/><path d="M10 4v16"/></svg></div>
                <p>Select a seller to view events</p>
            </div>
            {% endif %}
        </div>
    </div>
    <div id="panel-main" class="panel panel-main" data-panel="lots" hx-sync="this:replace">
        <div class="htmx-indicator"><div class="spinner"></div></div>
        <div id="panel-main-content" class="panel-content">
            {% if hydrate_lots is not None %}
                {% include "catalog/partials/lots_panel.html" with event=hydrate_event lots=hydrate_lots lot_rows=hydrate_lot_rows paginated=hydrate_lots_paginated event_id=selected_event_id seller_id=selected_seller_id pagination_url=hydrate_lots_pagination_url selected_event_id=selected_event_id oob_events=None %}
            {% else %}
            <div class="panel-empty">
                <div class="panel-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14h6"/><path d="M9 18h6"/></svg></div>
                <p>Select an event to view lots</p>
            </div>
            {% endif %}
        </div>
    </div>
    <div id="panel-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>
</div>
<dialog id="lot-modal" aria-labelledby="lot-modal-title">
    <div class="modal-container">
        <div class="modal-header">
            <h2 id="lot-modal-title">Lot Detail</h2>
            <button class="modal-close" aria-label="Close">&times;</button>
        </div>
        <div id="lot-modal-body" class="modal-body">
            <div class="modal-loading"><div class="spinner"></div></div>
        </div>
    </div>
</dialog>
<script>
(function() {
    var shell = document.querySelector('.shell');
    if (!shell) return;
    var backBtn = shell.querySelector('.mobile-back-btn');
    var announcer = document.getElementById('panel-announcer');
    var panelOrder = ['sellers', 'events', 'lots'];
    var panelLabels = {sellers: 'Sellers', events: 'Events', lots: 'Lots'};

    function isMobile() {
        return window.matchMedia('(max-width: 767px)').matches;
    }

    function showPanel(name) {
        shell.setAttribute('data-mobile-panel', name);
        backBtn.hidden = (name === 'sellers');
        if (announcer) announcer.textContent = panelLabels[name] + ' panel';
        var panel = shell.querySelector('[data-panel="' + name + '"]');
        if (panel) {
            var focusable = panel.querySelector('a, button, input, [tabindex]');
            if (focusable) focusable.focus();
        }
    }

    document.body.addEventListener('htmx:afterSwap', function(e) {
        if (!isMobile()) return;
        var target = e.detail.target;
        if (target.id === 'panel-left2-content') {
            showPanel('events');
        } else if (target.id === 'panel-main-content') {
            showPanel('lots');
        }
    });

    backBtn.addEventListener('click', function() {
        var current = shell.getAttribute('data-mobile-panel');
        var idx = panelOrder.indexOf(current);
        if (idx > 0) showPanel(panelOrder[idx - 1]);
    });

    window.addEventListener('resize', function() {
        if (!isMobile()) {
            backBtn.hidden = true;
            shell.setAttribute('data-mobile-panel', 'sellers');
        }
    });

    // --- Modal logic ---
    var dialog = document.getElementById('lot-modal');
    var modalBody = document.getElementById('lot-modal-body');
    var modalTitle = document.getElementById('lot-modal-title');
    var loadingHTML = '<div class="modal-loading"><div class="spinner"></div></div>';

    if (dialog) {
        // Close button
        dialog.querySelector('.modal-close').addEventListener('click', function() {
            dialog.close();
        });

        // Backdrop click (click on dialog element itself, not children)
        dialog.addEventListener('click', function(e) {
            if (e.target === dialog) dialog.close();
        });

        // Open modal after HTMX swaps content into modal body
        document.body.addEventListener('htmx:afterSwap', function(e) {
            if (e.detail.target === modalBody || e.detail.target.id === 'lot-modal-body') {
                // Update title from data attribute
                var firstChild = modalBody.firstElementChild;
                if (firstChild && firstChild.getAttribute('data-lot-title')) {
                    modalTitle.textContent = firstChild.getAttribute('data-lot-title');
                }
                if (!dialog.open) dialog.showModal();
            }
        });

        // Close modal on closeModal HX-Trigger event
        document.body.addEventListener('closeModal', function() {
            dialog.close();
        });

        // Show toast on showToast HX-Trigger event
        document.body.addEventListener('showToast', function(e) {
            var d = e.detail;
            if (d && d.message && window.showToast) {
                window.showToast(d.message, d.type || 'success');
            }
        });

        // Reset modal body to loading spinner when dialog closes
        dialog.addEventListener('close', function() {
            modalBody.innerHTML = loadingHTML;
            modalTitle.textContent = 'Lot Detail';
        });

        // Before HTMX sends request targeting modal body, show loading spinner
        document.body.addEventListener('htmx:beforeRequest', function(e) {
            var target = e.detail.target;
            if (target === modalBody || (target && target.id === 'lot-modal-body')) {
                modalBody.innerHTML = loadingHTML;
                if (!dialog.open) dialog.showModal();
            }
        });
    }

    // --- Gallery thumbnail navigation ---
    window.scrollToGalleryImage = function(index) {
        var gallery = document.querySelector('.lot-gallery');
        if (!gallery) return;
        var imgs = gallery.querySelectorAll('img');
        if (imgs[index]) {
            imgs[index].scrollIntoView({behavior: 'smooth', inline: 'start', block: 'nearest'});
        }
        // Update active thumbnail
        var thumbs = document.querySelectorAll('.lot-gallery-thumb');
        thumbs.forEach(function(t, i) {
            t.classList.toggle('active', i === index);
        });
    };

    // --- Pagination: jump-to-page ---
    document.body.addEventListener('click', function(e) {
        var display = e.target.closest('.page-display');
        if (!display) return;
        var jump = display.closest('.page-jump');
        if (!jump) return;
        var input = jump.querySelector('.page-input');
        display.hidden = true;
        input.hidden = false;
        input.select();
        input.focus();
    });

    function paginateToPage(input) {
        var page = Math.max(1, Math.min(parseInt(input.value) || 1, parseInt(input.max) || 1));
        var bar = input.closest('.panel-pagination');
        var baseUrl = bar.dataset.baseUrl;
        var target = bar.dataset.target;
        var extra = bar.dataset.extraParams || '';
        var url = baseUrl + '?page=' + page + extra;
        htmx.ajax('GET', url, {target: target, swap: 'innerHTML'});
    }

    document.body.addEventListener('keydown', function(e) {
        if (!e.target.classList.contains('page-input')) return;
        if (e.key === 'Enter') {
            e.preventDefault();
            paginateToPage(e.target);
        } else if (e.key === 'Escape') {
            e.preventDefault();
            var jump = e.target.closest('.page-jump');
            e.target.hidden = true;
            jump.querySelector('.page-display').hidden = false;
        }
    });

    document.body.addEventListener('focusout', function(e) {
        if (!e.target.classList.contains('page-input')) return;
        // Delay to allow click events to fire first
        var input = e.target;
        setTimeout(function() {
            if (!input.hidden) {
                var jump = input.closest('.page-jump');
                if (jump) {
                    input.hidden = true;
                    jump.querySelector('.page-display').hidden = false;
                }
            }
        }, 150);
    });

    // --- Pagination: page size selector ---
    document.body.addEventListener('change', function(e) {
        if (!e.target.classList.contains('page-size-select')) return;
        var select = e.target;
        var bar = select.closest('.panel-pagination');
        var baseUrl = bar.dataset.baseUrl;
        var target = bar.dataset.target;
        var extra = bar.dataset.extraParams || '';
        // Remove existing page_size from extra params, then add new one
        extra = extra.replace(/&page_size=[^&]*/g, '');
        var url = baseUrl + '?page=1&page_size=' + select.value + extra;
        htmx.ajax('GET', url, {target: target, swap: 'innerHTML'});
    });

    // --- Pagination: scroll to top on page change ---
    document.body.addEventListener('htmx:afterSwap', function(e) {
        var target = e.detail.target;
        if (target && target.closest('.panel')) {
            target.closest('.panel').scrollTop = 0;
        }
    });

    // --- Skeleton loading for events panel on seller click ---
    var skeletonHTML = '<div class="skeleton-loading">'
        + '<div class="skeleton-spinner"><div class="spinner"></div></div>'
        + '<ul class="skeleton-list">'
        + '<li class="skeleton-item"><div class="skeleton-bar skeleton-title"></div><div class="skeleton-bar skeleton-meta"></div></li>'
        + '<li class="skeleton-item"><div class="skeleton-bar skeleton-title"></div><div class="skeleton-bar skeleton-meta"></div></li>'
        + '<li class="skeleton-item"><div class="skeleton-bar skeleton-title"></div><div class="skeleton-bar skeleton-meta"></div></li>'
        + '</ul></div>';
    var mainEmptyHTML = '<div class="panel-empty">'
        + '<div class="panel-empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14h6"/><path d="M9 18h6"/></svg></div>'
        + '<p>Select an event to view lots</p></div>';

    document.body.addEventListener('htmx:beforeRequest', function(e) {
        var target = e.detail.target;
        if (target && target.id === 'panel-left2-content' && e.detail.elt.classList.contains('panel-item')) {
            target.innerHTML = skeletonHTML;
            var mainContent = document.getElementById('panel-main-content');
            if (mainContent) mainContent.innerHTML = mainEmptyHTML;
        }
    });

    // --- Row auto-save logic ---
    function getLotRow(el) {
        var tr = el.closest('tr[id^="lot-row-"]');
        return tr;
    }

    // Mark row dirty on input/change and reset 15s inactivity timer
    function markDirty(tr) {
        tr.dataset.dirty = '1';
        var btn = tr.querySelector('.btn-icon');
        if (btn) { btn.classList.add('save-dirty'); btn.classList.remove('save-clean'); }
        // Reset 15s inactivity timer
        if (tr._inactivityTimer) clearTimeout(tr._inactivityTimer);
        tr._inactivityTimer = setTimeout(function() {
            tr._inactivityTimer = null;
            if (tr.dataset.dirty === '1') htmx.trigger(tr, 'submit');
        }, 15000);
    }

    document.body.addEventListener('input', function(e) {
        var tr = getLotRow(e.target);
        if (tr) markDirty(tr);
    });
    document.body.addEventListener('change', function(e) {
        var tr = getLotRow(e.target);
        if (tr) markDirty(tr);
    });

    // CPack select color update on change
    var cpackClassMap = {'1':'cpack-nf','2':'cpack-lf','3':'cpack-f','4':'cpack-vf','PBO':'cpack-pbo'};
    document.body.addEventListener('change', function(e) {
        if (e.target.name !== 'cpack' || e.target.tagName !== 'SELECT') return;
        var sel = e.target;
        Object.keys(cpackClassMap).forEach(function(k) { sel.classList.remove(cpackClassMap[k]); });
        var cls = cpackClassMap[sel.value];
        if (cls) sel.classList.add(cls);
    });

    // Immediate save on row blur (focus leaving the row entirely)
    document.body.addEventListener('focusout', function(e) {
        var tr = getLotRow(e.target);
        if (!tr || tr.dataset.dirty !== '1') return;
        setTimeout(function() {
            var active = document.activeElement;
            if (active && tr.contains(active)) return;
            // Cancel inactivity timer — blur save takes over
            if (tr._inactivityTimer) { clearTimeout(tr._inactivityTimer); tr._inactivityTimer = null; }
            if (tr._autoSaveTimer) { clearTimeout(tr._autoSaveTimer); tr._autoSaveTimer = null; }
            if (tr.dataset.dirty === '1') htmx.trigger(tr, 'submit');
        }, 0);
    });

    // Cancel timers if focus returns to the row
    document.body.addEventListener('focusin', function(e) {
        var tr = getLotRow(e.target);
        if (tr && tr._autoSaveTimer) {
            clearTimeout(tr._autoSaveTimer);
            tr._autoSaveTimer = null;
        }
    });

    // Clear timers on immediate save click
    document.body.addEventListener('click', function(e) {
        if (!e.target.closest('.btn-icon[type="submit"]')) return;
        var tr = getLotRow(e.target);
        if (tr) {
            if (tr._autoSaveTimer) { clearTimeout(tr._autoSaveTimer); tr._autoSaveTimer = null; }
            if (tr._inactivityTimer) { clearTimeout(tr._inactivityTimer); tr._inactivityTimer = null; }
        }
    });

    // Concurrent save queueing: prevent overlapping saves for the same lot
    document.body.addEventListener('htmx:beforeRequest', function(e) {
        var tr = getLotRow(e.detail.elt);
        if (!tr) return;
        if (tr.dataset.saving === '1') {
            // A save is already in flight — queue this one
            e.preventDefault();
            tr._pendingSave = true;
            return;
        }
        tr.dataset.saving = '1';
    });

    // Mark row clean after successful HTMX swap, fire queued saves
    document.body.addEventListener('htmx:afterSwap', function(e) {
        var tr = e.detail.target;
        if (!tr || !tr.id || !tr.id.startsWith('lot-row-')) return;
        tr.dataset.saving = '';
        tr.dataset.dirty = '';
        if (tr._inactivityTimer) { clearTimeout(tr._inactivityTimer); tr._inactivityTimer = null; }
        var btn = tr.querySelector('.btn-icon');
        if (btn) {
            btn.classList.remove('save-dirty');
            btn.classList.add('save-clean');
            setTimeout(function() { btn.classList.remove('save-clean'); }, 3000);
        }
        // Fire queued save if there's a pending one
        if (tr._pendingSave) {
            tr._pendingSave = false;
            markDirty(tr);
            htmx.trigger(tr, 'submit');
        }
    });

    // Clear saving flag on request error too
    document.body.addEventListener('htmx:responseError', function(e) {
        var tr = getLotRow(e.detail.elt);
        if (tr) tr.dataset.saving = '';
    });
})();
</script>
{% endblock %}
