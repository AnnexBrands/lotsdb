# Implementation Plan: Restore Catalog Import with Merge

**Branch**: `019-restore-catalog-import` | **Date**: 2026-02-16 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/019-restore-catalog-import/spec.md`

## Summary

Restore the drag-and-drop "Add Catalog" dropzone in the navigation bar (removed during the 011 UX overhaul) and add merge-on-existing behavior. When a dropped file's catalog already exists on the server, the system fetches all server lots, computes a set difference by customer item ID, inserts new lots individually, deletes+recreates changed lots (preserving overrides), and skips identical lots. The existing `upload_catalog` view is extended with merge logic. A new `merge_catalog` service function handles the diff/reconciliation. The dropzone UI, CSS, and JS are restored to the navbar.

## Technical Context

**Language/Version**: Python 3.14, Django 5.2
**Primary Dependencies**: HTMX 2.0.4 (CDN), ABConnectTools 0.2.1 (editable install)
**Storage**: SQLite3 (sessions + Django User table) — no changes
**Testing**: pytest
**Target Platform**: Linux server, web browser
**Project Type**: Web application (Django monolith)
**Performance Goals**: New catalog import same as existing; merge processes lots individually (no concurrency required for MVP)
**Constraints**: No new Python or JS dependencies
**Scale/Scope**: 1 modified view, 1 new service function, 3 modified files (urls, base template, CSS), ~200 lines new code + ~80 lines restored code

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Artifact Harmony | PASS | Spec, contracts, data-model, quickstart, research, and tests all included in plan |
| II. Executable Knowledge | PASS | Contract tests for upload endpoint, unit tests for merge logic, integration tests for UI |
| III. Contracted Boundaries | PASS | API contract defined in `contracts/api.yaml` before implementation |
| IV. Versioned Traceability | PASS | Feature branch `019-restore-catalog-import` with spec-driven commits |
| V. Communicable Truth | PASS | quickstart.md documents manual and automated test procedures |

**Post-Phase 1 Re-check**: All pass. No new data models, no new dependencies, no architectural changes. The feature extends the existing upload view and adds a new service function.

## Project Structure

### Documentation (this feature)

```text
specs/019-restore-catalog-import/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0: technical research findings
├── data-model.md        # Phase 1: request/response shapes
├── quickstart.md        # Phase 1: testing guide
├── contracts/
│   └── api.yaml         # Phase 1: OpenAPI contract for upload endpoint
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── catalog/
│   ├── views/
│   │   └── imports.py           # MODIFIED: extend upload_catalog with merge branch
│   ├── templates/catalog/
│   │   └── base.html            # MODIFIED: restore dropzone to navbar, add upload JS
│   ├── static/catalog/
│   │   └── styles.css           # MODIFIED: add dropzone CSS
│   ├── services.py              # MODIFIED: add merge_catalog(), fetch_all_lots(), create_lot(), delete_lot()
│   └── urls.py                  # MODIFIED: add imports/upload/ route

tests/
├── contract/
│   └── test_upload.py           # NEW: upload endpoint contract tests
├── unit/
│   └── test_merge.py            # NEW: merge logic unit tests
└── integration/
    └── test_dropzone_ui.py      # NEW: dropzone UI integration tests
```

**Structure Decision**: Extends the existing Django monolith structure. No new apps or directories (except test subdirectories which may already exist). All changes are additions to existing files plus new test files.

## Complexity Tracking

> No violations. All changes are minimal additions to existing patterns.
