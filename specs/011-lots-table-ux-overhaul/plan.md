# Implementation Plan: Lots Table UX Overhaul

**Branch**: `011-lots-table-ux-overhaul` | **Date**: 2026-02-13 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/011-lots-table-ux-overhaul/spec.md`

## Summary

Overhaul the lots table to improve information density and editing workflow. Eight changes: simplify URL routing to SPA-only, fix number formatting, add color-coded CPack badges, remove visual noise (gridlines, image header), merge 5 dimension columns into 1, enlarge thumbnails, make description immutable in the table, and upgrade the lot modal with an image gallery and direct description/notes editing.

## Technical Context

**Language/Version**: Python 3.14, Django 5
**Primary Dependencies**: HTMX 2.0.4 (CDN), ABConnectTools 0.2.1 (editable install), Poppins font (Google Fonts CDN — new)
**Storage**: SQLite3 (sessions + Django User table) — no changes
**Testing**: pytest (`/usr/src/lotsdb/tests/`)
**Target Platform**: Linux server (gunicorn behind nginx)
**Project Type**: Web (Django + HTMX SPA)
**Performance Goals**: No degradation — changes are presentation-only (no new API calls)
**Constraints**: API `initial_data` is immutable; description/notes edits save to `overriden_data`
**Scale/Scope**: 8 discrete UI changes, ~10 files modified

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Artifact Harmony | ✅ PASS | Spec, plan, tests, templates, CSS all updated in this changeset |
| II. Executable Knowledge | ✅ PASS | Tests validate URL routing, template filters, override save flow |
| III. Contracted Boundaries | ✅ PASS | One new internal panel endpoint (`/panels/lots/<id>/text-save/`) for modal auto-save. Removed routes documented in data-model.md |
| IV. Versioned Traceability | ✅ PASS | Feature branch with full spec/plan artifacts |
| V. Communicable Truth | ✅ PASS | quickstart.md provides manual + automated test instructions |

No violations. Complexity Tracking section not needed.

## Project Structure

### Documentation (this feature)

```text
specs/011-lots-table-ux-overhaul/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 research findings
├── data-model.md        # Modified entities and removed routes
├── quickstart.md        # Manual + automated test guide
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── catalog/
│   ├── urls.py                                    # [MODIFY] Remove full-page routes
│   ├── forms.py                                   # [MODIFY] Adjust OverrideForm for modal text editing
│   ├── services.py                                # [MODIFY] Add merge-on-save logic to save_lot_override
│   ├── templatetags/
│   │   └── catalog_tags.py                        # [MODIFY] Add format_number, cpack_display filters
│   ├── views/
│   │   ├── panels.py                              # [MODIFY] Adjust lot_override_panel for new form structure
│   │   ├── auth.py                                # [NO CHANGE]
│   │   ├── sellers.py                             # [MODIFY] Remove full-page branch (keep SPA shell)
│   │   ├── events.py                              # [OPTIONAL] Dead code after route removal
│   │   ├── lots.py                                # [OPTIONAL] Dead code after route removal
│   │   ├── search.py                              # [OPTIONAL] Dead code after route removal
│   │   └── imports.py                             # [OPTIONAL] Dead code after route removal
│   ├── templates/catalog/
│   │   ├── base.html                              # [MODIFY] Add Poppins font CDN link
│   │   ├── shell.html                             # [MODIFY] Update modal JS if needed
│   │   └── partials/
│   │       ├── lots_table.html                    # [MODIFY] New column headers, remove Img header
│   │       ├── lots_table_row.html                # [MODIFY] Major restructure — merged dims, immutable desc, cpack badge
│   │       ├── lot_detail_modal.html              # [MODIFY] Restructure to gallery → desc → notes
│   │       └── lot_edit_modal.html                # [MODIFY] Restructure for direct text editing
│   └── static/catalog/
│       └── styles.css                             # [MODIFY] Remove gridlines, cpack colors, override style, gallery, thumb size
tests/
├── test_views.py                                  # [MODIFY] Update URL tests for removed routes
├── test_template_tags.py                          # [MODIFY] Add tests for new filters
└── ...
```

**Structure Decision**: Single Django project with `src/` and `tests/` directories (existing structure, no change).

## Implementation Details

### Phase A: URL Cleanup (FR-001)

**File**: `src/catalog/urls.py`

Remove these URL patterns:
```python
# REMOVE:
path("sellers/", seller_list, name="seller_list"),
path("sellers/<int:seller_id>/", seller_detail, name="seller_detail"),
path("events/<int:event_id>/", event_detail, name="event_detail"),
path("lots/<int:lot_id>/", lot_detail, name="lot_detail"),
path("lots/<int:lot_id>/override/", override_form, name="override_form"),
path("search/", search_lots_view, name="search"),
path("imports/", import_list, name="import_list"),
path("imports/run/", import_file, name="import_file"),
path("imports/upload/", upload_catalog, name="upload_catalog"),
```

Remove corresponding imports. The `seller_list` function is still referenced by the `home` URL pattern — only the `/sellers/` path binding is removed.

**File**: `src/catalog/views/sellers.py`

The `seller_list` view has a branch: `if request.path == "/":` renders the SPA shell, else renders the full-page list. After removing the `/sellers/` route, the `request.path == "/"` check can be simplified — the view is only ever called at `/`. Remove the full-page branch and the filter/pagination logic for it. Keep the SPA shell logic.

### Phase B: Template Filters (FR-002, FR-003, FR-004)

**File**: `src/catalog/templatetags/catalog_tags.py`

Add two new filters:

```python
@register.filter
def format_number(value):
    """Format a number: int if whole, decimal if fractional, empty if None."""
    if value is None:
        return ""
    try:
        f = float(value)
        return str(int(f)) if f == int(f) else str(f)
    except (ValueError, TypeError):
        return str(value)

CPACK_MAP = {
    "1": ("NF", "cpack-nf"),
    "2": ("LF", "cpack-lf"),
    "3": ("F", "cpack-f"),
    "4": ("VF", "cpack-vf"),
    "PBO": ("PBO", "cpack-pbo"),
}

@register.filter
def cpack_label(value):
    """Return the display label for a cpack value."""
    if value is None or value == "":
        return "—"
    label, _ = CPACK_MAP.get(str(value), (str(value), ""))
    return label

@register.filter
def cpack_class(value):
    """Return the CSS class for a cpack value."""
    if value is None or value == "":
        return ""
    _, cls = CPACK_MAP.get(str(value), ("", ""))
    return cls
```

### Phase C: Font Loading (FR-022)

**File**: `src/catalog/templates/catalog/base.html`

Add to `<head>`:
```html
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@900&display=swap" rel="stylesheet">
```

### Phase D: CSS Changes (FR-004, FR-005, FR-006, FR-009, FR-010)

**File**: `src/catalog/static/catalog/styles.css`

1. **Remove vertical gridlines**: Replace `.lots-table td { border: 1px solid #f1f5f9; }` with `.lots-table td { border: none; border-bottom: 1px solid #f1f5f9; }`.

2. **Larger thumbnails**: Change `.lot-thumb` from `40px` to `56px`. Adjust `.lot-thumb-placeholder` and `.lot-thumb-cell` width accordingly.

3. **CPack badge colors**:
```css
.cpack-badge { font-family: 'Poppins', sans-serif; font-weight: 900; font-size: 0.75rem; letter-spacing: 0.02em; }
.cpack-nf { color: #16a34a; }
.cpack-lf { color: #2563eb; }
.cpack-f  { color: #d97706; }
.cpack-vf { color: #dc2626; }
.cpack-pbo { color: #7c3aed; }
```

4. **Override styling per-input**: Remove `.overridden { background: #fff3cd; }`. Add:
```css
.lot-input-overridden { border-left: 2px solid #f59e0b; padding-left: 0.25rem; }
```

5. **Merged dimensions cell**:
```css
.lot-dims { display: flex; align-items: center; gap: 0.15rem; white-space: nowrap; font-size: 0.75rem; color: #64748b; }
.lot-dims input { width: 3rem; text-align: right; }
.lot-dims .lot-dims-wgt { width: 3.5rem; }
.lot-dims .lot-dims-sep { flex-shrink: 0; user-select: none; }
```

6. **Immutable description cell**:
```css
.lot-desc-text { font-size: 0.8125rem; color: #1e293b; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; cursor: pointer; }
```

7. **Modal image gallery**:
```css
.lot-gallery { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 0; border-radius: 8px 8px 0 0; background: #f1f5f9; max-height: 300px; }
.lot-gallery img { scroll-snap-align: start; flex-shrink: 0; width: 100%; height: auto; max-height: 300px; object-fit: contain; }
.lot-gallery-thumbs { display: flex; gap: 0.5rem; padding: 0.5rem 0; overflow-x: auto; }
.lot-gallery-thumbs img { width: 48px; height: 48px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 2px solid transparent; opacity: 0.6; }
.lot-gallery-thumbs img.active { border-color: #2563eb; opacity: 1; }
```

### Phase E: Lots Table Row Template (FR-005, FR-006, FR-007, FR-008, FR-009, FR-011, FR-012, FR-013)

**File**: `src/catalog/templates/catalog/partials/lots_table.html`

New column headers:
```html
<tr>
    <th></th>                    <!-- Image: no text -->
    <th>Lot Description</th>     <!-- Was: Desc/Notes -->
    <th>Dimensions</th>          <!-- Was: Qty, L, W, H, Wgt (5 cols) -->
    <th>CPack</th>
    <th>Crate</th>
    <th>DNT</th>
    <th></th>                    <!-- Save: no text change needed -->
</tr>
```

**File**: `src/catalog/templates/catalog/partials/lots_table_row.html`

Major restructure:
- **Image cell**: Same structure but with `lot-thumb` at 56px. Click triggers modal (already does via `hx-get`).
- **Description cell**: Replace `<textarea>` with `<div class="lot-desc-text">`. Add `hx-get` to open modal on click. Notes below as truncated immutable text.
- **Dimensions cell**: Single `<td>` with:
  ```html
  <div class="lot-dims">
    <input name="qty" value="{{ row.fields.qty.value|format_number }}" class="lot-input lot-input-num{% if row.fields.qty.changed %} lot-input-overridden{% endif %}" onfocus="this.select()">
    <span class="lot-dims-sep">@</span>
    <input name="l" value="{{ row.fields.l.value|format_number }}" class="lot-input lot-input-num{% if row.fields.l.changed %} lot-input-overridden{% endif %}" step="any" onfocus="this.select()">
    <span class="lot-dims-sep">x</span>
    <input name="w" ...>
    <span class="lot-dims-sep">x</span>
    <input name="h" ...>
    <span class="lot-dims-sep">,</span>
    <input name="wgt" ...>
    <span class="lot-dims-sep">lbs</span>
  </div>
  ```
- **CPack cell**: Replace `<select>` with a hidden `<select>` + visible badge, or use a styled `<select>` with letter codes:
  ```html
  <select name="cpack" class="lot-input lot-input-sm cpack-badge {{ row.fields.cpack.value|cpack_class }}">
    <option value="">—</option>
    <option value="1" ...>NF</option>
    <option value="2" ...>LF</option>
    <option value="3" ...>F</option>
    <option value="4" ...>VF</option>
    <option value="PBO" ...>PBO</option>
  </select>
  ```
  Use JS `onchange` to update the CSS class for color.
- **Crate, DNT, Save**: Unchanged (checkbox, checkbox, button).

**Description cell click-to-modal**: The description div needs `hx-get="/panels/lots/{{ row.lot.id }}/detail/" hx-target="#lot-modal-body" hx-swap="innerHTML"` to open the modal. Wrap it in a `<button>` or use `cursor: pointer` + HTMX attributes on the div.

### Phase F: Lot Detail Modal with Auto-Save (FR-014, FR-015, FR-016, FR-017, FR-020, FR-021)

**File**: `src/catalog/views/panels.py`

Add `lot_text_save` view function — accepts POST with `description` and/or `notes`, calls `save_lot_override` (merge logic preserves other overrides), re-fetches the lot, returns the `lots_table_row.html` fragment with OOB swap + HX-Trigger for `showToast`. Register URL: `panels/lots/<int:lot_id>/text-save/` in `urls.py`.

`lot_detail_panel` GET: Add `lot_description` and `lot_notes` as separate context variables (effective values: override if present, else initial). Remove description and notes from `_LOT_DETAIL_FIELDS` since they're displayed separately.

**File**: `src/catalog/services.py`

Add merge-on-save logic to `save_lot_override`: before creating `LotDataDto`, fetch the lot's existing `overriden_data[0]`, extract all non-None field values into a base dict, then overlay `override_data` on top. This ensures inline saves preserve description/notes overrides and modal saves preserve dimension/flag overrides (FR-020, FR-021).

**File**: `src/catalog/templates/catalog/partials/lot_detail_modal.html`

Restructure from current layout (data table + images at bottom) to:

```html
<div data-lot-title="Lot {{ lot.catalogs.0.lot_number|default:lot.id }}">
  <!-- 1. Image Gallery Header -->
  {% if lot.image_links %}
  <div class="lot-gallery" id="lot-gallery-{{ lot.id }}">
    {% for img in lot.image_links %}
    <img src="{{ img.link }}" alt="Lot image {{ forloop.counter }}">
    {% endfor %}
  </div>
  {% if lot.image_links|length > 1 %}
  <div class="lot-gallery-thumbs">
    {% for img in lot.image_links %}
    <img src="{{ img.link }}" alt="" class="{% if forloop.first %}active{% endif %}"
         onclick="scrollToGalleryImage(this, {{ forloop.counter0 }})">
    {% endfor %}
  </div>
  {% endif %}
  {% endif %}

  <!-- 2. Editable Description (auto-saves on blur) -->
  <div class="lot-modal-section">
    <h3>Description</h3>
    <textarea name="description" class="lot-modal-textarea"
              hx-post="/panels/lots/{{ lot.id }}/text-save/"
              hx-trigger="change" hx-swap="none"
              hx-headers='{"X-CSRFToken":"{{ csrf_token }}"}'>{{ lot_description|default:"" }}</textarea>
  </div>

  <!-- 3. Editable Notes (auto-saves on blur) -->
  <div class="lot-modal-section">
    <h3>Notes</h3>
    <textarea name="notes" class="lot-modal-textarea"
              hx-post="/panels/lots/{{ lot.id }}/text-save/"
              hx-trigger="change" hx-swap="none"
              hx-headers='{"X-CSRFToken":"{{ csrf_token }}"}'>{{ lot_notes|default:"" }}</textarea>
  </div>

  <!-- 4. Data Summary (dimensions, cpack, flags — read-only) -->
  <div class="lot-data">
    <h3>Lot Data</h3>
    <table>...</table>
  </div>
</div>
```

No "Edit" button for text fields — description and notes are directly editable and auto-save on blur via `hx-trigger="change"` (fires when the textarea loses focus if its value changed). The server responds with an OOB swap of the table row to keep the table in sync.

**File**: `src/catalog/templates/catalog/partials/lot_edit_modal.html`

Remove description and notes fields (they're auto-saved via the detail modal). The edit form is only for power fields: qty, l, w, h, wgt, value, cpack, noted_conditions, commodity_id, force_crate, do_not_tip. May be removed entirely if all editing moves to inline + modal auto-save.

### Phase G: Shell JS Updates

**File**: `src/catalog/templates/catalog/shell.html`

Add gallery thumbnail navigation JS (minimal):
```javascript
window.scrollToGalleryImage = function(thumb, index) {
    var gallery = thumb.closest('.lot-gallery-thumbs').previousElementSibling;
    var imgs = gallery.querySelectorAll('img');
    if (imgs[index]) imgs[index].scrollIntoView({behavior: 'smooth', block: 'nearest', inline: 'start'});
    thumb.closest('.lot-gallery-thumbs').querySelectorAll('img').forEach(function(t) { t.classList.remove('active'); });
    thumb.classList.add('active');
};
```

Add cpack select color update on change:
```javascript
document.body.addEventListener('change', function(e) {
    if (!e.target.matches('select[name="cpack"]')) return;
    var sel = e.target;
    sel.className = sel.className.replace(/cpack-\w+/g, '');
    var opt = sel.value;
    var classMap = {'1':'cpack-nf','2':'cpack-lf','3':'cpack-f','4':'cpack-vf','PBO':'cpack-pbo'};
    if (classMap[opt]) sel.classList.add('cpack-badge', classMap[opt]);
});
```

### Phase H: Tests

**File**: `tests/test_views.py` (or equivalent)

- Update URL routing tests: verify removed routes return 404
- Verify panel endpoints still work

**File**: `tests/test_template_tags.py` (new or existing)

- `format_number`: `10.0 → "10"`, `10.5 → "10.5"`, `None → ""`, `0.0 → "0"`
- `cpack_label`: `"1" → "NF"`, `"PBO" → "PBO"`, `None → "—"`, `"" → "—"`
- `cpack_class`: `"1" → "cpack-nf"`, `"4" → "cpack-vf"`, `None → ""`

## Complexity Tracking

No constitution violations. No complexity justification needed.
