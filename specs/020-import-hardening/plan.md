# Implementation Plan: Import Hardening

**Branch**: `020-import-hardening` | **Date**: 2026-02-17 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/020-import-hardening/spec.md`

## Summary

Harden the catalog import pipeline with four workstreams:
1. **Merge recovery** — cache failed lot payloads to Redis during merge, surface a recovery page with per-item check/retry/skip actions (FR-001–FR-007)
2. **Item search** — navbar search input resolving customer_item_id → seller + event + lot position via two API calls, redirecting to a deep-link with `?item=` support for lot-level highlighting (FR-008–FR-014)
3. **Upload UX** — deep-link redirect after import, sessionStorage toast persistence, 100%-failure detection, 1 MB file size limit, dropzone animation (FR-015–FR-019)
4. **Bug fixes** — cpack override indicator, events panel cache bug (`future_only` ignored on cache hit), inline save investigation, code cleanup (FR-020–FR-027)

## Technical Context

**Language/Version**: Python 3.14, Django 5.2
**Primary Dependencies**: HTMX 2.0.4 (CDN), ABConnectTools 0.2.1 (editable install), redis 7.1.1
**Storage**: SQLite3 (sessions + Django User table), Redis (cache — existing `default` backend)
**Testing**: pytest with django plugin
**Target Platform**: Linux server (WSL2 dev, gunicorn prod)
**Project Type**: Web application (Django + HTMX)
**Performance Goals**: Item search resolves in <5 seconds (2 API calls); recovery page loads instantly from Redis cache
**Constraints**: Upload file size <=1 MB; recovery cache TTL 24 hours; no new Python dependencies
**Scale/Scope**: Single-user typical usage; catalogs up to ~1000 lots

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| I. Artifact Harmony | PASS | spec, plan, research, data-model, contracts, quickstart, checklists all created; tests included in task plan |
| II. Executable Knowledge | PASS | Contract tests for all new endpoints, unit tests for recovery cache + item resolution, integration tests for search UI + recovery UI |
| III. Contracted Boundaries | PASS | `contracts/api.yaml` defines all new endpoints before implementation |
| IV. Versioned Traceability | PASS | Feature branch `020-import-hardening`, all changes in single PR |
| V. Communicable Truth | PASS | `quickstart.md` with manual validation steps for all 4 user stories |

**Post-design re-check**: PASS — no new violations introduced by research findings.

## Project Structure

### Documentation (this feature)

```text
specs/020-import-hardening/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 research findings
├── data-model.md        # Recovery entry + item search result models
├── quickstart.md        # Manual test plan
├── contracts/
│   └── api.yaml         # OpenAPI contracts for new endpoints
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
src/
├── catalog/
│   ├── services.py          # MODIFY: resolve_item, recovery cache helpers, fix list_catalogs cache bug
│   ├── urls.py              # MODIFY: add search, recovery routes
│   ├── views/
│   │   ├── imports.py       # MODIFY: deep-link redirect, recovery cache on failure, file size check
│   │   ├── sellers.py       # MODIFY: ?item= param handling, pagination computation
│   │   ├── panels.py        # MODIFY: cpack indicator fix, events panel fix
│   │   └── recovery.py      # NEW: recovery dashboard, check, retry, skip views
│   ├── templates/catalog/
│   │   ├── base.html        # MODIFY: search input, sessionStorage toast, dropzone animation
│   │   ├── recovery.html    # NEW: recovery dashboard page template
│   │   ├── partials/
│   │   │   ├── lots_table_row.html    # MODIFY: cpack indicator
│   │   │   ├── recovery_row.html      # NEW: recovery table row partial
│   │   │   └── recovery_status.html   # NEW: check-server result partial
│   │   └── shell.html       # MODIFY: ?item= context for lot highlighting
│   └── static/catalog/
│       └── styles.css       # MODIFY: dropzone animation, recovery page, lot active highlight, CSS reformat

tests/
├── contract/
│   ├── test_upload.py       # MODIFY: deep-link redirect, recovery_url in response
│   ├── test_search.py       # NEW: item search endpoint tests
│   └── test_recovery.py     # NEW: recovery check/retry/skip endpoint tests
├── integration/
│   ├── test_dropzone_ui.py  # MODIFY: extract shared fixture, file size check, toast persistence
│   └── test_recovery_ui.py  # NEW: recovery page UI tests
└── unit/
    ├── test_merge.py        # MODIFY: recovery cache integration, 100%-failure re-raise
    ├── test_resolve.py      # NEW: resolve_item service tests
    └── test_cache.py        # EXISTING: no changes expected
```

**Structure Decision**: Existing Django app structure. New `views/recovery.py` module for the recovery dashboard (4 views). New templates for recovery page. All other changes are modifications to existing files.
