# Implementation Plan: Access Control

**Branch**: `010-access-control` | **Date**: 2026-02-13 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/010-access-control/spec.md`

## Summary

Add an authorization layer to LotsDB that bridges ABConnect authentication to Django's User model, enabling `is_staff`-based access control. Phase 1: staff users get full access (preserving current behavior), non-staff users see a "no access" page. The architecture is designed so Phase 2 can swap in an API-based policy (user → allowed sellers + events) without modifying views.

## Technical Context

**Language/Version**: Python 3.14, Django 5
**Primary Dependencies**: ABConnectTools 0.2.1 (editable install), HTMX 2.0.4 (CDN), Django built-in auth framework
**Storage**: SQLite3 (sessions + Django User table via `django.contrib.auth`)
**Testing**: pytest (`.venv/bin/python -m pytest tests/ -v`)
**Target Platform**: Linux server (gunicorn behind systemd)
**Project Type**: web (single Django app)
**Performance Goals**: Login bridging adds one `get_or_create` query (~1ms on SQLite). Authorization checks are in-memory boolean operations. No measurable impact.
**Constraints**: No new Python dependencies. Must not break existing sessions on deployment.
**Scale/Scope**: Single-tenant deployment (~5 concurrent users). Phase 2 will add multi-user filtering.

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Artifact Harmony | PASS | Spec, contracts, data model, tests, and quickstart all produced together |
| II. Executable Knowledge | PASS | Unit tests for authorization service, integration tests for middleware |
| III. Contracted Boundaries | PASS | Authorization service contract defined in `contracts/authorization.md` |
| IV. Versioned Traceability | PASS | Feature branch with full commit history |
| V. Communicable Truth | PASS | Quickstart validates deployment and manual testing steps |

**Post-Phase 1 Re-check**: PASS — all design artifacts are consistent with spec requirements.

## Project Structure

### Documentation (this feature)

```text
specs/010-access-control/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 research decisions
├── data-model.md        # Entity definitions and state transitions
├── quickstart.md        # Manual testing and verification steps
├── contracts/
│   └── authorization.md # Authorization service API contract
└── tasks.md             # Generated by /speckit.tasks (not yet created)
```

### Source Code (repository root)

```text
src/
├── config/
│   └── settings.py              # Modified: ACCESS_POLICY setting
├── catalog/
│   ├── authorization.py         # NEW: authorization service module
│   ├── services.py              # Modified: login() bridges Django User
│   ├── middleware.py             # Modified: authorization enforcement
│   ├── urls.py                  # Modified: /no-access/ route
│   ├── views/
│   │   └── auth.py              # Modified: no_access view
│   └── templates/
│       └── catalog/
│           └── auth/
│               └── no_access.html   # NEW: no access page template

tests/
├── unit/
│   ├── test_authorization.py    # NEW: authorization service unit tests
│   └── test_login_bridge.py     # NEW: login bridge unit tests
├── integration/
│   └── test_middleware_auth.py   # NEW: middleware authorization tests
└── conftest.py                  # Modified: Django User fixtures
```

**Structure Decision**: Single Django app (`catalog`), no new apps. Authorization module added as a service alongside existing `services.py`. Tests follow existing `tests/unit/` and `tests/integration/` layout.

## Complexity Tracking

No constitution violations. The feature adds one new module (`authorization.py`), one new template, and modifications to 4 existing files. This is the minimum needed to introduce the authorization abstraction and Phase 2 extensibility.
